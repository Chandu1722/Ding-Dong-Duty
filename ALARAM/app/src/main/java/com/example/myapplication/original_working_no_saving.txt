package com.example.myapplication


import android.app.AlarmManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.unit.dp
import kotlinx.coroutines.delay
import java.text.SimpleDateFormat
import java.util.*
class MainActivity : ComponentActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            AlarmApp()
        }
    }
}

@Composable
fun AlarmApp() {
    val context = LocalContext.current

    var currentTime by remember { mutableStateOf("") }
    var currentDate by remember { mutableStateOf("") }
    var nearestAlarmText by remember { mutableStateOf("No alarm set") }

    // Simple text fields for hour and minute input
    var hourText by remember { mutableStateOf("") }
    var minuteText by remember { mutableStateOf("") }

    // Update date and time every second
    LaunchedEffect(Unit) {
        while (true) {
            val now = Calendar.getInstance()
            currentDate = SimpleDateFormat("EEE, MMM d, yyyy", Locale.getDefault()).format(now.time)
            currentTime = SimpleDateFormat("HH:mm:ss", Locale.getDefault()).format(now.time)
            delay(1000)
        }
    }

    Scaffold(
        topBar = { TopAppBar(title = { Text("Compose Alarm App") }) }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .padding(paddingValues)
                .padding(16.dp)
                .fillMaxSize(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(text = currentDate, style = MaterialTheme.typography.h5)
            Text(text = currentTime, style = MaterialTheme.typography.h4)

            Spacer(Modifier.height(16.dp))

            Text(text = "Nearest Alarm: $nearestAlarmText", style = MaterialTheme.typography.h6)

            Spacer(Modifier.height(32.dp))

            Row(verticalAlignment = Alignment.CenterVertically) {
                OutlinedTextField(
                    value = hourText,
                    onValueChange = { newText ->
                        if (newText.all { it.isDigit() } && newText.toIntOrNull() in 0..23 || newText.isEmpty()) {
                            hourText = newText
                        }
                    },
                    label = { Text("Hour (0-23)") },
                    singleLine = true,
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                    modifier = Modifier.width(120.dp)
                )

                Spacer(Modifier.width(16.dp))

                OutlinedTextField(
                    value = minuteText,
                    onValueChange = { newText ->
                        if (newText.all { it.isDigit() } && newText.toIntOrNull() in 0..59 || newText.isEmpty()) {
                            minuteText = newText
                        }
                    },
                    label = { Text("Minute (0-59)") },
                    singleLine = true,
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                    modifier = Modifier.width(120.dp)
                )
            }

            Spacer(Modifier.height(24.dp))

            Button(
                onClick = {
                    val hour = hourText.toIntOrNull()
                    val minute = minuteText.toIntOrNull()
                    if (hour != null && minute != null) {
                        setAlarm(context, hour, minute)
                        nearestAlarmText = String.format("%02d:%02d", hour, minute)
                    }
                },
                enabled = hourText.isNotEmpty() && minuteText.isNotEmpty()
            ) {
                Text("Set Alarm")
            }
        }
    }
}

private fun setAlarm(context: Context, hour: Int, minute: Int) {
    val alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager
    val intent = Intent(context, AlarmReceiver::class.java)
    val pendingIntent = PendingIntent.getBroadcast(
        context,
        0,
        intent,
        PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
    )
    val alarmTime = Calendar.getInstance().apply {
        set(Calendar.HOUR_OF_DAY, hour)
        set(Calendar.MINUTE, minute)
        set(Calendar.SECOND, 0)
        set(Calendar.MILLISECOND, 0)
        if (before(Calendar.getInstance())) add(Calendar.DATE, 1)
    }
    alarmManager.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, alarmTime.timeInMillis, pendingIntent)
}